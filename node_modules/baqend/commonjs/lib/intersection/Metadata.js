"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.Metadata = exports.MetadataState = void 0;
var Acl_1 = require("../Acl");
var util_1 = require("../util");
var error_1 = require("../error");
var MetadataState;
(function (MetadataState) {
    MetadataState[MetadataState["UNAVAILABLE"] = -1] = "UNAVAILABLE";
    MetadataState[MetadataState["PERSISTENT"] = 0] = "PERSISTENT";
    MetadataState[MetadataState["DIRTY"] = 1] = "DIRTY";
})(MetadataState = exports.MetadataState || (exports.MetadataState = {}));
/**
 * The Metadata instance tracks the state of an object and checks if the object state was changed since last
 * load/update. The metadata keeps therefore the state of:
 * - in which state the object currently is
 * - which db managed the instance
 * - the metadata of the object (id, version, bucket)
 * - which is the owning object (root object) of an embedded object
 *
 * {@link Metadata#get(object)} can be used on any managed object to retrieve the metadata of the root object
 */
var Metadata = /** @class */ (function (_super) {
    __extends(Metadata, _super);
    /**
     * @param type
     */
    function Metadata(type) {
        var _this = _super.call(this) || this;
        _this.entityManager = null;
        _this.decodedKey = null;
        _this.id = null;
        _this.state = MetadataState.DIRTY;
        _this.enabled = true;
        _this.id = null;
        _this.version = null;
        _this.type = type;
        _this.acl = new Acl_1.Acl();
        return _this;
    }
    Metadata.create = function (type, db) {
        if (type.isEntity) {
            return new Metadata(type);
        }
        if (type.isEmbeddable) {
            return { type: type, db: db, setDirty: function () { } };
        }
        throw new Error("Illegal type " + type);
    };
    /**
     * Returns the metadata of the managed object
     * @param managed
     * @return
     */
    Metadata.get = function (managed) {
        // eslint-disable-next-line no-underscore-dangle
        return managed._metadata;
    };
    Object.defineProperty(Metadata.prototype, "db", {
        /**
         * @type EntityManager
         */
        get: function () {
            if (this.entityManager) {
                return this.entityManager;
            }
            this.entityManager = require('../baqend').db; // eslint-disable-line global-require
            return this.entityManager;
        },
        /**
         * @param db
         */
        set: function (db) {
            if (!this.entityManager) {
                this.entityManager = db;
            }
            else {
                throw new Error('DB has already been set.');
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Metadata.prototype, "bucket", {
        /**
         * @type string
         * @readonly
         */
        get: function () {
            return this.type.name;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Metadata.prototype, "key", {
        /**
         * @type string
         * @readonly
         */
        get: function () {
            if (!this.decodedKey && this.id) {
                var index = this.id.lastIndexOf('/');
                this.decodedKey = decodeURIComponent(this.id.substring(index + 1));
            }
            return this.decodedKey;
        },
        /**
         * @param value
         */
        set: function (value) {
            var val = "" + value;
            if (this.id) {
                throw new Error('The id can\'t be set twice.');
            }
            this.id = "/db/" + this.bucket + "/" + encodeURIComponent(val);
            this.decodedKey = val;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Metadata.prototype, "isAttached", {
        /**
         * Indicates if this object already belongs to an db
         * <code>true</code> if this object belongs already to an db otherwise <code>false</code>
         * @type boolean
         * @readonly
         */
        get: function () {
            return !!this.entityManager;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Metadata.prototype, "isAvailable", {
        /**
         * Indicates if this object is represents a db object, but was not loaded up to now
         * @type boolean
         * @readonly
         */
        get: function () {
            return this.state > MetadataState.UNAVAILABLE;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Metadata.prototype, "isPersistent", {
        /**
         * Indicates if this object represents the state of the db and was not modified in any manner
         * @type boolean
         * @readonly
         */
        get: function () {
            return this.state === MetadataState.PERSISTENT;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Metadata.prototype, "isDirty", {
        /**
         * Indicates that this object was modified and the object was not written back to the db
         * @type boolean
         * @readonly
         */
        get: function () {
            return this.state === MetadataState.DIRTY;
        },
        enumerable: false,
        configurable: true
    });
    /**
     * Enable/Disable state change tracking of this object
     * @param newStateTrackingState The new change tracking state
     * @return
     */
    Metadata.prototype.enable = function (newStateTrackingState) {
        this.enabled = newStateTrackingState;
    };
    /**
     * Throws the corresponding error if a property is accessed before the owning object is loaded
     * @throws an exception if the object properties aren't available and the object is enabled
     */
    Metadata.prototype.throwUnloadedPropertyAccess = function (property) {
        if (this.enabled && !this.isAvailable) {
            throw new error_1.PersistentError("Illegal property access on " + this.id + "#" + property + " , ensure that this reference is loaded before it's properties are accessed.");
        }
    };
    /**
     * Indicates that the associated object isn't available
     * @return
     */
    Metadata.prototype.setUnavailable = function () {
        this.state = MetadataState.UNAVAILABLE;
    };
    /**
     * Indicates that the associated object is not stale
     *
     * An object is stale if it correlates the database state and is not modified by the user.
     *
     * @return
     */
    Metadata.prototype.setPersistent = function () {
        this.state = MetadataState.PERSISTENT;
    };
    /**
     * Indicates the the object is modified by the user
     * @return
     */
    Metadata.prototype.setDirty = function () {
        this.state = MetadataState.DIRTY;
    };
    /**
     * Indicates the the object is removed
     * @return
     */
    Metadata.prototype.setRemoved = function () {
        // mark the object only as dirty if it was already available
        if (this.isAvailable) {
            this.setDirty();
            this.version = null;
        }
    };
    return Metadata;
}(util_1.Lockable));
exports.Metadata = Metadata;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWV0YWRhdGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvaW50ZXJzZWN0aW9uL01ldGFkYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw4QkFBNkI7QUFDN0IsZ0NBQW1DO0FBR25DLGtDQUEyQztBQWMzQyxJQUFZLGFBSVg7QUFKRCxXQUFZLGFBQWE7SUFDdkIsZ0VBQWdCLENBQUE7SUFDaEIsNkRBQWMsQ0FBQTtJQUNkLG1EQUFTLENBQUE7QUFDWCxDQUFDLEVBSlcsYUFBYSxHQUFiLHFCQUFhLEtBQWIscUJBQWEsUUFJeEI7QUFFRDs7Ozs7Ozs7O0dBU0c7QUFDSDtJQUE4Qiw0QkFBUTtJQXNKcEM7O09BRUc7SUFDSCxrQkFBWSxJQUFxQjtRQUFqQyxZQUNFLGlCQUFPLFNBUVI7UUFqS0QsbUJBQWEsR0FBeUIsSUFBSSxDQUFDO1FBSTNDLGdCQUFVLEdBQWtCLElBQUksQ0FBQztRQUVqQyxRQUFFLEdBQWtCLElBQUksQ0FBQztRQXFKdkIsS0FBSSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO1FBQ2pDLEtBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLEtBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ2YsS0FBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsS0FBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsS0FBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLFNBQUcsRUFBRSxDQUFDOztJQUN2QixDQUFDO0lBL0hNLGVBQU0sR0FBYixVQUFnQyxJQUFvQixFQUFFLEVBQWtCO1FBQ3RFLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixPQUFPLElBQUksUUFBUSxDQUFDLElBQXFCLENBQUMsQ0FBQztTQUM1QztRQUFDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN2QixPQUFPLEVBQUUsSUFBSSxNQUFB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